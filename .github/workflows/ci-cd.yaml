name: CI/CD Pipeline

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

env:
  AWS_REGION: eu-west-1  # Replace with your region
  ECR_REGISTRY: 024848484634.dkr.ecr.eu-west-1.amazonaws.com
  NAMESPACE: jeremy-opare

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Login to Amazon ECR
      id: login-ecr
      uses: aws-actions/amazon-ecr-login@v2

    - name: Build Frontend Image
      working-directory: ./frontend
      run: |
        docker build \
          -t ${{ env.ECR_REGISTRY }}/jeremy-opare/frontend:latest \
          -t ${{ env.ECR_REGISTRY }}/jeremy-opare/frontend:${{ github.sha }} \
          .

    - name: Push Frontend Image
      run: |
        docker push ${{ env.ECR_REGISTRY }}/jeremy-opare/frontend:latest
        docker push ${{ env.ECR_REGISTRY }}/jeremy-opare/frontend:${{ github.sha }}

    - name: Build Backend Image
      working-directory: ./backend
      run: |
        docker build \
          -t ${{ env.ECR_REGISTRY }}/jeremy-opare/backend:latest \
          -t ${{ env.ECR_REGISTRY }}/jeremy-opare/backend:${{ github.sha }} \
          .

    - name: Push Backend Image
      run: |
        docker push ${{ env.ECR_REGISTRY }}/jeremy-opare/backend:latest
        docker push ${{ env.ECR_REGISTRY }}/jeremy-opare/backend:${{ github.sha }}

    - name: Install kubectl
      uses: azure/setup-kubectl@v3
      with:
        version: 'latest'

    - name: Configure kubectl for EKS
      run: |
        aws eks update-kubeconfig --name innovation --region ${{ env.AWS_REGION }}

    - name: Deploy to Kubernetes
      run: |
        # Apply namespace
        kubectl apply -f k8s/namespace.yaml
        
        # Update image tags in deployments
        sed -i "s|024848484634.dkr.ecr.eu-west-1.amazonaws.com|${{ env.ECR_REGISTRY }}|g" k8s/deployment-frontend.yaml
        sed -i "s|024848484634.dkr.ecr.eu-west-1.amazonaws.com|${{ env.ECR_REGISTRY }}|g" k8s/deployment-backend.yaml
        
        # Apply all Kubernetes manifests
        kubectl apply -f k8s/ --namespace=${{ env.NAMESPACE }}
        
        # Wait for deployments to be ready
        kubectl rollout status deployment/frontend --namespace=${{ env.NAMESPACE }} --timeout=5m
        kubectl rollout status deployment/backend --namespace=${{ env.NAMESPACE }} --timeout=5m

    - name: Verify Deployment
      run: |
        echo "=== Pods Status ==="
        kubectl get pods --namespace=${{ env.NAMESPACE }}
        
        echo "=== Services ==="
        kubectl get services --namespace=${{ env.NAMESPACE }}
        
        echo "=== Ingress ==="
        kubectl get ingress --namespace=${{ env.NAMESPACE }}

    - name: Run Health Checks
      run: |
        # Wait for pods to be ready
        kubectl wait --for=condition=ready pod -l app=frontend --namespace=${{ env.NAMESPACE }} --timeout=300s
        kubectl wait --for=condition=ready pod -l app=backend --namespace=${{ env.NAMESPACE }} --timeout=300s
        
        echo "All pods are healthy!"